rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Default rule - deny access
    match /{allPaths=**} {
      allow read, write: if false;
    }
    
    // صور المنتجات - متاحة للقراءة فقط
    match /products/{productId}/{allImages=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
    
    // صور الفئات - متاحة للقراءة فقط
    match /categories/{categoryId}/{allImages=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
    
    // صور البانر - متاحة للقراءة فقط
    match /banners/{allBanners=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
    
    // صور المستخدمين - يمكن للمستخدم رفع وقراءة صورته الشخصية فقط
    match /users/{userId}/{allImages=**} {
      allow read: if true;
      allow write: if request.auth != null && (request.auth.uid == userId || request.auth.token.admin == true);
    }
    
    // ملفات التمويل الشخصي - خاصة للمستخدم
    match /finance/{userId}/{allFiles=**} {
      allow read: if request.auth != null && (request.auth.uid == userId || request.auth.token.admin == true);
      allow write: if request.auth != null && (request.auth.uid == userId || request.auth.token.admin == true);
    }
    
    // صور المراجعات - متاحة للقراءة فقط
    match /reviews/{reviewId}/{allImages=**} {
      allow read: if true;
      allow write: if request.auth != null && (
        (resource == null && request.resource.size < 5 * 1024 * 1024) || // لا يتجاوز حجم الصورة 5 ميجابايت
        request.auth.token.admin == true
      );
    }
    
    // صور عامة للمتجر - متاحة للقراءة فقط
    match /store/{allImages=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
    
    // User profile images - only the owner can view and modify
    match /profiles/{userId}/{allImages=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Public assets - anyone can view
    match /public/{allAssets=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
    
    // Order attachments - owner and admin access
    match /orders/{orderId}/{allAttachments=**} {
      allow read: if request.auth != null && (
                   // Either admin or the owner of the order
                   request.auth.token.admin == true || 
                   request.auth.uid == orderId.split('_')[0]
                 );
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
  }
} 